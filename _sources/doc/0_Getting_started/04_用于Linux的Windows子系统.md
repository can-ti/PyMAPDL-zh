# 用于Linux的Windows子系统
本页解释如何在 Windows 子系统 for Linux (WSL)中使用 PyAnsys 库，更确切地说是 PyMAPDL。WSL 是一个在 Windows 10，Windows 11 和 Windows Server 2019 上运行 Linux 二进制可执行文件的兼容层。有关更多信息，请参见:

- [维基百科 WSL](https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux)
- Microsoft’s [What is the Windows Subsystem for Linux](https://docs.microsoft.com/en-us/windows/wsl/about).

本页将引导您在 Windows 上安装 WSL，然后展示如何与 MAPDL、 PyMAPDL 和 [Docker](https://www.docker.com/) 一起使用它。

```{admonition} 注意
:class: caution

这种方法还没有通过 VPN 连接完全测试过。如果在连接 WSL 到 Internet 时遇到任何问题，请尝试断开与 VPN 的连接。
```

## 在WSL上运用PyMAPDL
WSL 有两个版本: WSL1和 WSL2。因为与 WSL1相比，WSL2提供了许多改进，所以您应该升级到并使用 WSL2。

### 安装WSL
按照 Microsoft 的说明安装 WSL: [安装 WSL](https://docs.microsoft.com/en-us/windows/wsl/install/)。

### 安装 CentOS7 WSL 发行版
在使用 PyAnsys 库时，应该使用 CentOS7WSL 发行版。

您可以使用 [CentOS-WSL包](https://github.com/wsldl-pg/CentWSL/) 或 [CentOS WSL包](https://github.com/mishamosher/CentOS-WSL/) 中的非官方 WSL 发行版安装此发行版。

您也可以选择尝试 Ubuntu，但是它还没有在 WSL 环境下进行测试。

### 在 WSL CentOS 7 中安装 Ansys 产品

#### 前提
如果您正在使用 CentOS 7，在安装 MAPDL 之前，您必须安装一些必需的库:

```
sudo yum install openssl openssh-clients mesa-libGL mesa-libGLU motif libgfortran
```

如果您正在使用 Ubuntu，请遵循 [Run MAPDL: Ubuntu] 中的说明。

#### 安装 Ansys 产品
要在 WSL Linux 中安装 Ansys 产品，请执行以下步骤:

1. 从门户网站下载 **Ansys Structures** 镜像（[当前版本](https://download.ansys.com/Current%20Release)）。

    如果在 Windows 机器上下载镜像，以后应该将镜像从下载文件夹复制到 WSL。

2. 使用以下命令提取压缩的源代码文件(`tar.gz`) :
    ```
    tar xvzf STRUCTURES_2021R2_LINX64.tgz
    ```

3. 要安装 MAPDL，进入已经解压缩的文件夹并运行以下命令:
    ```
    sudo ./INSTALL -silent -install_dir /usr/ansys_inc/ -mechapdl
    ```

    在这里:

 > - `-silent`:启动静默安装，这意味着没有显示 GUI。
 > - `-install_dir /path/`:指定要安装产品或许可证管理器的目录。如果要安装到默认位置，可以省略 `-install_dir` 参数。如果设置了符号链接，则默认位置为 `/ansys_inc`。否则，它默认为 `/usr/ansys_inc`。
 > - `-<product_flag>`:指定要安装的一个或多个产品。如果省略此参数，则安装所有产品。Ansys Help 中的 *Ansys, Inc. Installation Guides* 为 Linux 安装指南的第6章和 Windows 安装指南的第7章中的 `product_Flag` 参数提供了有效值的列表。
 > 在上面的 MAPDL 示例中，您只需要指定 `-mechapdl` flag。

在 `/ansys_inc` 或 `/usr/ansys_inc` 中直接安装 MAPDL 后，你用以下命令创建一个符号链接：

```
sudo ln -s /usr/ansys_inc /ansys_inc
```

默认情况下， PyMAPDL 希望 `MAPDL` **可执行文件**位于 `/usr/ansys_inc`。无论你是否在那里安装它，你都应该使用符号链接将该目录与你的Ansys安装目录（`/*/ansys_inc`）联系起来。

```{margin} MAPDL 可执行文件
感觉这个文件位置应该蛮重要的,尤其对于安装时修改了默认安装路径的情况!
```

#### 安装后的位置
##### 为许可证服务器通信打开端口
% 试着写了一个definition list
**Theory**
: 您应该在 Windows 控制面板中打开端口1055和2325以进行许可证服务器通信。有关设置高级 Windows 防火墙选项的步骤，请参阅微软的“[如何在 Windows 10防火墙中打开端口](https://answers.microsoft.com/en-us/windows/forum/all/how-to-open-port-in-windows-10-firewall/f38f67c8-23e8-459d-9552-c1b94cca579a/)”。

**Reality**
: 如果您希望使用 WSL Linux 映像运行 Docker 映像来托管该 Docker 映像，那么这种方法是可行的。如果在运行打开这些端口的 Docker 映像时使用 `'-p'` 标志，则 Docker 映像将成功地使用这些端口与 Windows 许可证服务器进行通信。

如果您想在 CentOS 7 镜像中运行 MAPDL 并使用 Windows 许可证服务器，打开端口可能无法正常工作，因为 Windows 防火墙似乎会阻止所有来自 WSL 的通信。为了安全起见，您仍应尝试在防火墙中打开 1055 和 2325 端口，并验证您的 MAPDL 安装是否可以与 Windows 主机通信。如果您在设置防火墙规则后仍有问题，您可能要关闭 WSL 以太网虚拟接口的 Windows 防火墙。这可能会带来一些未知的副作用和安全风险，所以要慎重使用。欲了解更多信息，请参阅[在 WSL 以太网上禁用防火墙](https://github.com/cascadium/wsl-windows-toolbar-launcher#firewall-rules)。

##### 在 WSL 中设置一个指向 Windows 主机许可证服务器的环境变量
Windows 主机的 IP 地址在 WSL `/etc/hosts` 文件名 `host.docker.Internal` 之前。

```{note}
如果没有安装 Docker，那么这个 `host.Docker.Internal` 定义可能不可用。
```

下面是 WSL `/etc/hosts` 文件的一个示例:

```{code-block}
:caption:  WSL `/etc/hosts` 文件示例
:emphasize-lines: 8

# This file was automatically generated by WSL.
# To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateHosts = false
127.0.0.1       localhost
127.0.1.1       AAPDDqVK5WqNLve.win.ansys.com   AAPDDqVK5WqNLve

192.168.0.12    host.docker.internal
192.168.0.12    gateway.docker.internal
127.0.0.1       kubernetes.docker.internal

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

你可以在你的 WSL `~/. bashrc` 文件中添加下面几行来创建一个带有这个 IP 地址的环境变量:

```{code-block}
winhostIP=$(grep -m 1 host.docker.internal /etc/hosts | awk '{print $1}')
export ANSYSLMD_LICENSE_FILE=1055@$winhostIP
```

#### 在 WSL 中启动 MAPDL
要在 WSL 中启动 MAPDL，你必须启动 MAPDL 进程。下面是一个例子。

```
/ansys_inc/v222/ansys/bin/ansys222 -grpc
```

这将启动一个 MAPDL 实例，其工作目录是当前目录。如果你想改变工作目录，你可以使用 `-dir` 标志。

```
/ansys_inc/v222/ansys/bin/ansys222 -grpc -dir /tmp/ansys_jobs/myjob
```

#### 连接到一个在 WSL 中运行的 MAPDL 实例
要连接到正在运行 MAPDL 实例的 WSL 实例，你需要指定 WSL 实例的 IP 地址：

```python
from ansys.mapdl.core import Mapdl
mapdl = Mapdl(ip='127.0.0.1', port=50053)
```

## 附加信息

### WSL 和 Windows 主机中的 IP 地址
**Theory**:
你应该能够使用 WSL `/etc/hosts` 文件中指定的 IP 地址访问 Windows 主机。这个 IP 地址通常是 `127.0.1.1`。这意味着本地 WSL 的 IP 地址是 127.0.0.1。

**Reality**:
使用 IP 地址 `127.0.1.1` 来连接到 Windows 主机几乎是不可能的。然而，可以在同一个 WSL `/etc/hosts` 文件中使用`host.docker.internal` 主机名。这是一个随机分配的 IP 地址，这在你定义许可证服务器时是一个问题。不过，按照这里提到的更新 `.bashrc` 文件就可以解决这个问题。

从 WSL 角度看，IP 地址 `127.0.0.1` 是WSL CentOS的 IP 地址，而 Windows 主机的 IP 地址通常是`127.0.1.1`。

Docker 以 WSL 发行版作为基础构建 PyMAPDL 镜像。因此， PyMAPDL 运行在一个 Linux WSL 发行版上，而 WSL 发行版则运行在一个 Windows 主机上。由于 Docker 镜像与 WSL 共享资源，它也与 WSL 发行版共享内部 IP 地址。

### Ansys 安装标志
#### 获得帮助
要获得许可证服务器信息，使用以下方法之一访问 INSTALL 文件，然后检查最后几行。

- 方法 1
```
./INSTALL --help
```

- 方法 2
```
cat ./INSTALL
```

#### 客户端的许可证服务器信息
`-licserverinfo` 参数指定了许可证服务器的客户端使用的信息。这个参数只在静默安装(*silent installation*)（INSTALL）时有效。

##### 单个许可证服务器
单个许可证服务器的格式如下:

```
-licserverinfo LI_port_number:FLEXlm_port_number:hostname
```

这里有一个例子:

```
./INSTALL -silent -install_dir /ansys_inc/ -mechapdl -licserverinfo 2325:1055:winhostIP
```

##### 三个许可证服务器
三个许可证服务器的格式如下:

```
-licserverinfo LI_port_number:FLEXlm_port_number:hostname1,hostname2,hostname3
```

这里有一个例子:

```
./INSTALL -silent -install_dir /ansys_inc/ -mechapdl -licserverinfo 2325:1055:abc,def,xyz
```

#### 安装语言
`-Lang` 参数指定安装所使用的语言。

#### 指定要安装的产品文件
你可以指定一个 `option` 文件，列出你要安装的产品。当你这样做时，你必须使用 `-productfile` 参数来指定 `option` 文件的完整路径。

### 在 WSL 以太网上禁用防火墙
有两种方法可以禁用 WSL 以太网上的防火墙。

- 方法 1

    此方法显示一个通知:
    ```
    Set-NetFirewallProfile -DisabledInterfaceAliases "vEthernet (WSL)"
    ```

- 方法 2

    此方法不显示通知:
    ```
    powershell.exe -Command "Set-NetFirewallProfile -DisabledInterfaceAliases \"vEthernet (WSL)\""
    ```
    链接: [禁用 WSL 以太网上的防火墙](https://github.com/cascadium/wsl-windows-toolbar-launcher#firewall-rules)

### Windows10上的端口转发
你可以使用 Windows PowerShell 命令在 Windows10 上进行端口转发。

#### 在 WSL 和 Windows 之间链接端口
这个命令链接 WSL 和 Windows 之间的端口:

```
netsh interface portproxy add v4tov4 listenport=1055 listenaddress=0.0.0.0 connectport=1055 connectaddress=XXX.XX.XX.XX
```

#### 查看所有转发
这个命令允许您查看所有转发:

```
netsh interface portproxy show v4tov4
```

#### 删除端口转发
此命令允许您删除端口转发:

```
netsh interface portproxy delete v4tov4 listenport=1055 listenaddres=0.0.0.0 protocol=tcp
```

### 重置 Windows 网络适配器
您可以使用以下代码重置 Windows 网络适配器:

```
netsh int ip reset all
netsh winhttp reset proxy
ipconfig /flushdns
netsh winsock reset
```

### 重新启动 WSL 服务
您可以使用以下命令重新启动 WSL 服务:

```
Get-Service LxssManager | Restart-Service
```

### 停止所有具有给定名称的进程
你可以用这个命令停止所有具有指定名称的进程。

```
Get-Process "ANSYS212" | Stop-Process
```

### Install xvfb in CentOS 7
如果你想复制 CI/CD 行为，你必须安装 `xvfb` 包，如以下命令所示。欲了解更多信息，请参见 `.ci` 文件夹。

```
yum install xorg-x11-server-Xvfb
```

### Notes
- PyMAPDL只有在 WSL 上运行时才会对共享内存并行（SMP）起作用。这就是为什么要加入标志 `-smp` 的原因。
- 因为 VPN 和 INTEL MPI 之间存在一些不兼容性，所以在调用 MAPDL 时使用标志`-MPI msmpi`。





